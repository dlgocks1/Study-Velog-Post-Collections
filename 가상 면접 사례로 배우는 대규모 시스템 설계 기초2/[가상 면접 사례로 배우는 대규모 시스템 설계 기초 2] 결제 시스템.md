## 구조

결제 서비스는 제 3자 제공업체를 사용한다.
이를 PSP라고 부르며 대금 수신흐름은 아래와 같다.

![](https://velog.velcdn.com/images/cksgodl/post/c274e0db-ba55-454b-a5d3-47d578caa516/image.png)

## 데이터 모델

ACID 트랜잭션을 지원하는 전통적인 RDB를 선호한다.

추가적인 이유로는 아래와 같다.

- 복식부기 및 원장 시스템 연계: 거래의 차감·입금이 정확히 기록돼야 하므로 정교한 트랜잭션 관리가 중요.
- 보안 기능 강화: 데이터 암호화(TDE), 세분화된 접근제어, 감사 기록 등 보안 정책을 강력히 지원.
- 확장성 및 운영 경험: 오랜 기업지원 경험, 레거시 시스템과 호환 가능성이 높음.

---

또한 결제 주문 테이블의 NOT_STARTED, EXECUTING, SUCCES, FAIL등의 상태를 통해 EDA(Event Driven Archiretcture)를 통해 결제 시스템을 구현할 수 있다.

[[팀네이버 컨퍼런스 DAN 24] 네이버페이 결제 시스템의 성장과 변화](https://tv.naver.com/v/67445495)

![](https://velog.velcdn.com/images/cksgodl/post/3b165793-7d3a-4d97-a21c-5e258d967382/image.png)

![](https://velog.velcdn.com/images/cksgodl/post/a7a85971-c567-4e5f-a0c6-fb2036af6679/image.png)

## 재시도 큐 및 실패 메시지 큐

> DLQ(Dead Letter Queue)는 메시지 처리 과정에서 소비자(컨슈머)가 정상적으로 처리하지 못한, 즉 오류나 예외가 발생해 처리 실패한 메시지를 별도로 보관하는 큐(Queue) 또는 카프카에서는 별도의 토픽(Topic)을 말합니다

![](https://velog.velcdn.com/images/cksgodl/post/1224e310-e38f-4fb7-adec-00b1d3af93de/image.png)

![](https://velog.velcdn.com/images/cksgodl/post/1a4c1928-8367-478e-bdc1-5f6ec8264e5a/image.png)

실패 메시지 큐와 재시도 큐를 활용한다.

-> 보통 실패 매시지 큐를 활용하여 롤백 커밋을 하는 듯

### 정확히 한번

> [Kafka Message Delivery Semantics - Exactly Once 는 정말 가능할까?](https://huisam.tistory.com/entry/kafka-message-semantics#google_vignette)

카프카의 exatly once를 구현하는 방식에 대한 고찰

#### 프로듀서

- 멱등성 프로듀서 설정
   - Producer 의 설정을 acks = all 로 설정
   - enable.idempotence = true 로 설정합니다.
idempotence 설정은 Broker 에게 ProducerID(PID) 를 전송하여 중복체크를 할 수 있게 전송 

#### 컨슈머

![](https://velog.velcdn.com/images/cksgodl/post/dd936ff3-ade1-4692-950d-aba56db32aab/image.png)

 Consumer 가 commit 을 우선시 할 것이냐 Processing 을 우선시 할 것이냐 를 선택해도 Exactly once 를 보장할 수는 없다. 
 
어느 순간이든 네트워크 문제로 메시지 커밋이 실패할 수 있기 때문이다.

따라서 Consumer 의 비동기 commit 인 auto.commit = true 를 활성화하고, 메세지에 대한 Consume 기록을 DB 로 하는 방향을 활용할 수 있다.

그렇게 되면, Application 에서 Processing Fail 이 발생해도 안전하게 재시도가 가능하기 때문이다.

![](https://velog.velcdn.com/images/cksgodl/post/7f375816-84cc-4817-bdfa-3994b1854337/image.png)


> Exactly once 전략을 사용하기 위해서는 Producer 에는 idempotence 와 ack 옵션을, Consumer 에는 메세지 consume 기록을 위한 DB 를 활용해야 한다. (DLQ 느낌?)


